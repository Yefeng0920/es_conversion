---
title: "PCC conversion"
output: html_document
author: "Yefeng Yang and Shinichi Nakagawa"
date: '2023-02-24'
---

# Resources
https://easystats.github.io/effectsize/reference/t_to_r.html
https://onlinelibrary.wiley.com/doi/full/10.4073/cmpn.2016.3

# Raw data (SMD and lnRR) with descriptive statistics

For this type of data, we need to provide t and df, then they can use the two quantities to calculate r correct SE(r) and wrong SE(r).

```{r}
library(here)
library(dplyr)

ft037_raw <- read.csv(here("data","ft037_raw.csv")) 
ft037_raw <- ft037_raw[-1] # only keep necessary variables

# calculate t according to its definition in two-sample test
# https://www.statology.org/two-sample-t-test/
tval <- function(n1, n2, sd1, sd2, m1, m2) { # function to calculate independent samples t-test
  sdp <- ((n1 - 1) * sd1^2 + (n2 - 1) * sd2^2) / (n1 + n2 - 2) # calculate pooled SD
  tval <- (m1 - m2) / (sdp * sqrt(1 / n1 + 1 / n2)) # test stat - https://www.statology.org/two-sample-t-test/
  return(tval) 
}

# compute t
ft037_raw <- ft037_raw %>% mutate(t = tval(n1=T_n, n2=C_n, sd1=T_sd, sd2=C_sd, m1=T_mean, m2=C_mean), # t
                                  df = T_n + C_n - 2, # degrees of freedom
                                  )


```


# SMD without descriptive statistics

For this type of data, we need to convert SMD into r and approximate df based on var(SMD). Then they can use the two quantities to calculate r correct SE(r) and wrong SE(r).

```{r}
ft056_precalculated <- read.csv(here("data","ft056_processed.csv")) 
ft056_precalculated <- ft056_precalculated[-1] # only keep necessary variables

# convert SMD into r
ft056_precalculated <- ft056_precalculated %>% mutate(r = es / sqrt(es^2 + 4)) # appendix A - https://onlinelibrary.wiley.com/doi/full/10.4073/cmpn.2016.3

# approximate df based on the formula of var(SMD), assuming equal sample size between two groups
ft056_precalculated <- ft056_precalculated %>% mutate(n = (8 + es^2)/(4*var), # n = sample size of each group within each study
                                                      df = 2*n - 2)



#ft056_precalculated <- ft056_precalculated %>% mutate(t = es*sqrt(n) / 2) # t appendix C - https://onlinelibrary.wiley.com/doi/full/10.4073/cmpn.2016.3

```


# Zr

For this type of data, we need to convert Zr into r and calculate df based on var(Zr). Then they can use the two quantities to calculate r correct SE(r) and wrong SE(r).

```{r}
ft012 <- read.csv(here("data","ft012.csv")) 
ft012  <- ft012[-1] # keep relevant variables

# calculate n based on Var(Zr)
ft012 <- ft012 %>% mutate(n = 1/var + 3, # sample size of each study
                          df = n - 2)

# convert Zr into r
ft012 <- ft012 %>% mutate(r = (exp(2*es) - 1)/(1 + exp(2*es)), # from Zr to r
                          es2 = 0.5*log((1+r)/(1-r))) # from r to Zr to double-check

```

